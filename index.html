<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nyc e Ni</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #333;
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.85);
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            pointer-events: none;
        }
        .modal.is-active { opacity: 1; pointer-events: auto; }
        .modal-image { transform: scale(0.95); transition: transform 0.3s ease-in-out; }
        .modal.is-active .modal-image { transform: scale(1); }
        .back-button { transition: transform 0.2s; }
        .back-button:hover { transform: translateX(-5px); }
        .photo-item { cursor: grab; }
        .photo-item.dragging { opacity: 0.5; border: 2px dashed #9ca3af; }
        .drop-zone { border: 2px dashed #3b82f6; background-color: #eff6ff; transition: background-color 0.2s; }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-6">

    <header class="w-full max-w-5xl text-center mb-8">
        <h1 id="main-title" class="text-4xl font-extrabold text-gray-800 mb-2">Galeria de Álbuns</h1>
        <p id="main-subtitle" class="text-xl text-gray-600">fotos nyc e ni</p>
    </header>   

    <main id="app-container" class="w-full max-w-5xl">
        <p class="text-center text-gray-500">Carregando álbuns...</p>
    </main>

    <div id="lightbox-modal" class="modal fixed inset-0 flex items-center justify-center p-4 z-50">
        <div class="relative w-full max-w-4xl max-h-full">
            <img id="modal-image" class="modal-image w-full h-auto object-contain rounded-xl shadow-2xl" src="" alt="Foto Ampliada">
            <button id="close-modal-btn" class="absolute top-4 right-4 text-white text-3xl font-bold bg-gray-800 bg-opacity-50 hover:bg-opacity-75 rounded-full w-10 h-10 flex items-center justify-center">&times;</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
                apiKey: "AIzaSyAQxhEQFrL4L2W_8B5oYZt12UoE8ojSkV0",
                authDomain: "galeria-d93d9.firebaseapp.com",
                databaseURL: "https://galeria-d93d9-default-rtdb.firebaseio.com",
                projectId: "galeria-d93d9",
                storageBucket: "galeria-d93d9.appspot.com",
                messagingSenderId: "943324121087",
                appId: "1:943324121087:web:5204e0311a56ebc938c9ca",
                measurementId: "G-R8CCVM1PV5"
            };

            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const storage = firebase.storage();
            const albumsRef = db.collection('galeria').doc('principal');
            const storageRef = storage.ref();

            let albums = []; 

            async function saveAlbums() {
                try {
                    await albumsRef.set({ albums });
                    console.log("Álbuns salvos com sucesso no Firebase!");
                } catch (e) {
                    console.error("Erro ao salvar álbuns: ", e);
                }
            }

            async function getDownloadUrl(localPath) {
                if (!localPath || typeof localPath !== 'string') throw new Error("Caminho da imagem inválido.");
                try {
                    const fileRef = storageRef.child(localPath);
                    return await fileRef.getDownloadURL();
                } catch (e) {
                    console.error(`Erro ao obter a URL para ${localPath}: `, e);
                    throw e; 
                }
            }

            async function loadAlbums() {
                try {
                    const doc = await albumsRef.get();
                    if (doc.exists && doc.data().albums) {
                        albums = doc.data().albums;
                    } else {
                        albums = [
                            { id: 'viagem-rio', title: 'Viagem ao Rio de Janeiro', coverImage: 'WhatsApp%20Image%202025-08-29%20at%2018.19.19.png', photos: ['WhatsApp%20Image%202025-08-29%20at%2018.19.19.png', 'https://placehold.co/800x600/fecaca/991b1b?text=Rio+2'] },
                            { id: 'passeio-parque', title: 'Passeio no Parque', coverImage: 'https://placehold.co/400x300/d1fae5/065f46?text=Capa+Parque', photos: ['https://placehold.co/800x600/a7f3d0/065f46?text=Parque+1'] }
                        ];
                        saveAlbums(); 
                    }
                    renderAlbums();
                } catch (e) {
                    console.error("Erro fatal ao carregar álbuns: ", e);
                    appContainer.innerHTML = `<div class="text-center bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded" role="alert"><p><strong>Erro de Conexão:</strong> Não foi possível carregar os álbuns.</p></div>`;
                }
            }
            
            const appContainer = document.getElementById('app-container');
            const mainTitle = document.getElementById('main-title');
            const mainSubtitle = document.getElementById('main-subtitle');

            async function renderAlbums() {
                appContainer.innerHTML = '';
                mainTitle.textContent = 'Galeria de Álbuns';
                mainSubtitle.textContent = 'Escolha um álbum ou crie um novo';

                const albumsGrid = document.createElement('div');
                albumsGrid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8';

                // Botão para adicionar novo álbum
                const addAlbumCard = document.createElement('div');
                addAlbumCard.className = 'flex items-center justify-center bg-gray-100 rounded-xl border-2 border-dashed border-gray-400 hover:border-blue-500 hover:bg-blue-50 transition-all duration-300 cursor-pointer min-h-[220px]';
                addAlbumCard.innerHTML = `<div class="text-center text-gray-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg><span class="text-lg font-semibold">Adicionar Novo Álbum</span></div>`;
                addAlbumCard.addEventListener('click', showAddAlbumModal);
                albumsGrid.appendChild(addAlbumCard);

                const albumPromises = albums.map(async (album) => {
                    try {
                        let coverUrl = album.coverImage || 'https://placehold.co/400x300/e0e0e0/ffffff?text=Sem+Capa';
                        if (coverUrl && !coverUrl.startsWith('http')) {
                            coverUrl = await getDownloadUrl(coverUrl);
                        }
                        return { ...album, coverUrl, hasError: false };
                    } catch (error) {
                        return { ...album, coverUrl: 'https://placehold.co/400x300/f87171/ffffff?text=Erro+na+Imagem', hasError: true };
                    }
                });

                const albumsWithData = await Promise.all(albumPromises);
                albumsWithData.forEach(album => {
                    const albumCard = document.createElement('div');
                    albumCard.className = `relative bg-white rounded-xl shadow-lg group transition-all duration-300 ${album.hasError ? '' : 'hover:shadow-xl transform hover:scale-105'}`;
                    
                    albumCard.innerHTML = `
                        <div class="cursor-pointer">
                            <img src="${album.coverUrl}" alt="Capa: ${album.title}" class="w-full h-48 object-cover rounded-t-xl ${album.hasError ? 'grayscale' : ''}">
                            <div class="p-5 text-center"><h3 class="text-xl font-semibold ${album.hasError ? 'text-red-500' : 'text-gray-700'}">${album.title}</h3></div>
                        </div>
                        <div class="absolute top-2 right-2 flex space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button data-action="edit" class="bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 shadow-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                            <button data-action="delete" class="bg-red-500 text-white p-2 rounded-full hover:bg-red-600 shadow-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
                        </div>
                    `;
                    
                    albumCard.querySelector('[data-action="edit"]').addEventListener('click', (e) => { e.stopPropagation(); showEditAlbumModal(album.id); });
                    albumCard.querySelector('[data-action="delete"]').addEventListener('click', (e) => { e.stopPropagation(); deleteAlbum(album.id); });
                    if (!album.hasError) {
                        albumCard.querySelector('.cursor-pointer').addEventListener('click', () => renderAlbumPhotos(album.id));
                    }
                    albumsGrid.appendChild(albumCard);
                });
                appContainer.appendChild(albumsGrid);
            }

            function showAddAlbumModal() {
                showAlbumModal({
                    modalTitle: 'Criar Novo Álbum',
                    onSave: async (newTitle) => {
                        const newAlbum = {
                            id: `album-${Date.now()}`,
                            title: newTitle,
                            coverImage: '',
                            photos: []
                        };
                        albums.push(newAlbum);
                        await saveAlbums();
                        renderAlbums();
                    }
                });
            }

            function showEditAlbumModal(albumId) {
                const album = albums.find(a => a.id === albumId);
                if (!album) return;
                showAlbumModal({
                    modalTitle: 'Editar Título do Álbum',
                    initialValue: album.title,
                    onSave: async (updatedTitle) => {
                        album.title = updatedTitle;
                        await saveAlbums();
                        renderAlbums();
                    }
                });
            }

            function showAlbumModal({ modalTitle, initialValue = '', onSave }) {
                const modalOverlay = document.createElement('div');
                modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modalOverlay.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
                        <h3 class="text-2xl font-bold mb-4">${modalTitle}</h3>
                        <input type="text" id="album-title-input" class="w-full p-2 border border-gray-300 rounded-lg mb-4" value="${initialValue}" placeholder="Digite o título do álbum">
                        <div class="flex justify-end space-x-4">
                            <button id="cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancelar</button>
                            <button id="save-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">Salvar</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modalOverlay);
                const titleInput = document.getElementById('album-title-input');
                titleInput.focus();

                const closeModal = () => document.body.removeChild(modalOverlay);

                document.getElementById('save-btn').addEventListener('click', () => {
                    const newTitle = titleInput.value.trim();
                    if (newTitle) {
                        onSave(newTitle);
                        closeModal();
                    }
                });
                document.getElementById('cancel-btn').addEventListener('click', closeModal);
            }

            async function deleteAlbum(albumId) {
                if (confirm('Tem certeza que deseja excluir este álbum? Esta ação não pode ser desfeita.')) {
                    albums = albums.filter(a => a.id !== albumId);
                    await saveAlbums();
                    renderAlbums();
                }
            }
            
            async function renderAlbumPhotos(albumId) {
                /* ... (código inalterado) ... */
            }

            function renderEditMode(album) {
                appContainer.innerHTML = '';
                mainTitle.textContent = `Editando: ${album.title}`;
                mainSubtitle.textContent = 'Arraste para reordenar, remova, adicione ou defina a capa.';

                const saveAndBackBtn = document.createElement('button');
                saveAndBackBtn.className = 'back-button mb-6 text-green-600 hover:text-green-800 font-semibold flex items-center text-lg';
                saveAndBackBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>Salvar e Voltar`;
                saveAndBackBtn.addEventListener('click', () => renderAlbums());
                appContainer.appendChild(saveAndBackBtn);

                /* ... (restante da função renderEditMode inalterada, com a adição do botão de capa) ... */

                const photoListContainer = document.createElement('div');
                photoListContainer.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
                appContainer.appendChild(photoListContainer);

                async function renderPhotoListForEdit(album) {
                    photoListContainer.innerHTML = '';
                    const photoItems = await Promise.all(album.photos.map(async (photoUrl, index) => {
                        let displayUrl = photoUrl;
                        if (photoUrl && !photoUrl.startsWith('http')) {
                            displayUrl = await getDownloadUrl(photoUrl).catch(() => 'https://placehold.co/100x100/f87171/ffffff?text=Erro');
                        }
                        const isCover = album.coverImage === photoUrl;
                        const photoItem = document.createElement('div');
                        photoItem.className = 'bg-white rounded-xl shadow-md p-2 flex items-center group photo-item';
                        photoItem.draggable = true; photoItem.dataset.index = index;
                        
                        photoItem.innerHTML = `
                            <img src="${displayUrl}" alt="Foto ${index + 1}" class="w-16 h-16 object-cover rounded-lg mr-4">
                            <span class="truncate flex-grow text-sm text-gray-700">${photoUrl}</span>
                            <div class="flex items-center space-x-2">
                                <button data-action="set-cover" class="${isCover ? 'text-yellow-400' : 'text-gray-400'} hover:text-yellow-400" title="Definir como capa">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                                </button>
                                <button data-action="remove" class="px-2 py-1 bg-red-500 text-white rounded-full text-xs hover:bg-red-600">&times;</button>
                            </div>
                        `;
                        
                        photoItem.querySelector('[data-action="set-cover"]').addEventListener('click', async (e) => {
                            e.stopPropagation();
                            album.coverImage = photoUrl;
                            await saveAlbums();
                            renderPhotoListForEdit(album); // Re-renderiza para mostrar a estrela preenchida
                        });
                        photoItem.querySelector('[data-action="remove"]').addEventListener('click', async (e) => { e.stopPropagation(); album.photos.splice(index, 1); renderPhotoListForEdit(album); await saveAlbums(); });

                        // Drag and drop listeners
                        photoItem.addEventListener('dragstart', (e) => { /* ... */ });
                        photoItem.addEventListener('dragend', async (e) => { /* ... */ });
                        photoItem.addEventListener('dragover', (e) => { /* ... */ });
                        photoItem.addEventListener('drop', (e) => { /* ... */ });

                        return photoItem;
                    }));
                    photoItems.forEach(item => photoListContainer.appendChild(item));
                }
                renderPhotoListForEdit(album);
            }
            
            // Funções restantes (openLightbox, closeLightbox, etc.) permanecem inalteradas

            loadAlbums();
        });
    </script>
</body>
</html>
